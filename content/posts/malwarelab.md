+++
title = 'Laboratorio de análisis de malware'
+++

## Diagrama de laboratorio

![malware lab setup](/images/posts/malwarelab/malwarelabvbox.png)

---

## Links de máquinas virtuales

[VirtualBox](https://www.virtualbox.org/)

[Windows](https://www.microsoft.com/en-us/software-download/windows10ISO)

[REMnux](https://docs.remnux.org/install-distro/get-virtual-appliance)

---

## Comando para crear red interna en VirtualBox

```bash
vboxmanage dhcpserver add --netname=malwarelab --ip=10.50.1.1 --netmask=255.255.255.0 --lowerip=10.50.1.10 --upperip=10.50.1.30 --enable
```
---

## Snapshot de la máquina virtual Windows

```txt
=====================================
REALIZAR ANTES DE CUALQUIER CAMBIO ⚠️
=====================================
```

![snapshot 1](/images/posts/malwarelab/snapshot1.png)
![snapshot 2](/images/posts/malwarelab/snapshot2.png)
![snapshot 3](/images/posts/malwarelab/snapshot3.png)

---

## Deshablitar seguridad de Windows

![Deshablitar seguridad windows 1](/images/posts/malwarelab/seguridadwindows1.png)

![Deshablitar seguridad windows 2](/images/posts/malwarelab/seguridadwindows2.png)

![Deshablitar seguridad windows 3](/images/posts/malwarelab/seguridadwindows3.png)

---

## Deshablitar Firewall

![Deshablitar Firewall](/images/posts/malwarelab/desfirewall.png)

---

## Deshablitar smartscreen 

![Deshablitar smartscreen](/images/posts/malwarelab/smartscreen.png)

---

## Apagar Windows Defender de forma permanente

![Apagar Windows Defender](/images/posts/malwarelab/apagardefender.png)

```bash
Arranque a prueba de errores (safe boot) > Aplicar (Apply)
```

![Apagar Windows Defender 1](/images/posts/malwarelab/apagardefender1.png)

```bash
============
REINICIAR ↻
============
```

![Apagar Windows Defender 2](/images/posts/malwarelab/apagardefender2.png)

```txt
Windows Defender > click derecho > propiedades
```

![Apagar Windows Defender 3](/images/posts/malwarelab/apagardefender3.png)

```txt
Seguridad > Opciones avanzadas
```

![Apagar Windows Defender 4](/images/posts/malwarelab/apagardefender4.png)

![Apagar Windows Defender 5](/images/posts/malwarelab/apagardefender5.png)

![Apagar Windows Defender 6](/images/posts/malwarelab/apagardefender6.png)

![Apagar Windows Defender 7](/images/posts/malwarelab/apagardefender7.png)

![Apagar Windows Defender 8](/images/posts/malwarelab/apagardefender8.png)

```txt
Eliminar todos los usuarios de la lista > tildar las casillas "Reemplazar propietario..." y "Reemplazar todas las entradas de permisos de objetos..."
```

`Antes`

![Apagar Windows Defender 9](/images/posts/malwarelab/apagardefender9.png)

`Después`

![Apagar Windows Defender 10](/images/posts/malwarelab/apagardefender10.png)

```bash
=======================
Volver al modo original
=======================

Deshablitar arranque a prueba de errores (safe boot) > Aplicar (Apply)

============
REINICIAR ↻
============
```

![Apagar Windows Defender 2](/images/posts/malwarelab/apagardefender2.png)


![Apagar Windows Defender 11](/images/posts/malwarelab/apagardefender11.png)

---

## Deshablitar actualizaciones


![Deshablitar actualizaciones](/images/posts/malwarelab/disableupdates.png)

![Deshablitar actualizaciones 1](/images/posts/malwarelab/disableupdates1.png)

```powershell
PS > Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser

PS > .\winutil.ps1
```

![Deshablitar actualizaciones 2](/images/posts/malwarelab/disableupdates2.png)

![Deshablitar actualizaciones 3](/images/posts/malwarelab/disableupdates3.png)



---

## Configuración de inetsim en REMnux

```bash
sudo nano /etc/inetsim/inetsim.conf
```

```bash
===========  
Descomentar
===========

#start_service dns  
start_service dns
...................................

==================================
Descomentar y cambiar dirección IP 
==================================

#service_bind_address 10.10.10.1  
service_bind_address 0.0.0.0

...................................

==================================
Descomentar y cambiar dirección IP
==================================

#dns_default_ip		10.10.10.1 
dns_default_ip  10.50.1.13

...................................

===========================================================================
10.50.1.13 ES LA IP ASIGNADA DE FORMA DINÁMICA EN LA RED INTERNA malwarelab 
===========================================================================
```

```txt
==================
GUARDAR Y SALIR 💾
==================  
```

### Activar inetsim

```bash  
remnux@remnux:~$ inetsim
INetSim 1.3.2 (2020-05-19) by Matthias Eckert & Thomas Hungenberg
Using log directory:      /var/log/inetsim/
Using data directory:     /var/lib/inetsim/
Using report directory:   /var/log/inetsim/report/
Using configuration file: /etc/inetsim/inetsim.conf
Parsing configuration file.
Configuration file parsed successfully.
=== INetSim main process started (PID 1630) ===
Session ID:     1630
Listening on:   10.50.1.13
Real Date/Time: 2024-06-01 19:12:36
Fake Date/Time: 2024-06-01 19:12:36 (Delta: 0 seconds)
 Forking services...
  * dns_53_tcp_udp - started (PID 1634)
  * smtps_465_tcp - started (PID 1638)
  * smtp_25_tcp - started (PID 1637)
  * pop3s_995_tcp - started (PID 1640)
  * pop3_110_tcp - started (PID 1639)
  * https_443_tcp - started (PID 1636)
  * http_80_tcp - started (PID 1635)
  * ftps_990_tcp - started (PID 1642)
  * ftp_21_tcp - started (PID 1641)
 done.
Simulation running.
```

---

## Configuración de red de las VMs

![netconfig VMs](/images/posts/malwarelab/netconfigvms.png)

---

## Prueba de inetsim desde Windows

![prueba inetsim Windows](/images/posts/malwarelab/inetsim.png)

---

## Modificación de DNS en Windows

![inetsim DNS Windows](/images/posts/malwarelab/inetsim1.png)

![inetsim DNS Windows](/images/posts/malwarelab/inetsim2.png)

![inetsim  DNS Windows](/images/posts/malwarelab/inetsim3.png)

![inetsim DNS Windows](/images/posts/malwarelab/inetsim4.png)

![inetsim DNS Windows](/images/posts/malwarelab/inetsim5.png)

---

## Test de conexión entre VMs


### Dirección IP de Windows en la red interna malwarelab  

```powershell  
PS C:\Users\winmalwareuser> ipconfig

Configuración IP de Windows


Adaptador de Ethernet Ethernet:

   Sufijo DNS específico para la conexión. . :
   Vínculo: dirección IPv6 local. . . : fe80::78a5:6d62:841b:1ad4%4
   Dirección IPv4. . . . . . . . . . . . . . : 10.50.1.14
   Máscara de subred . . . . . . . . . . . . : 255.255.255.0
```

### Ping desde Windows hacia REMnux

```powershell  
PS C:\Users\winmalwareuser> ping 10.50.1.13

Haciendo ping a 10.50.1.13 con 32 bytes de datos:
Respuesta desde 10.50.1.13: bytes=32 tiempo<1m TTL=64
Respuesta desde 10.50.1.13: bytes=32 tiempo<1m TTL=64
Respuesta desde 10.50.1.13: bytes=32 tiempo<1m TTL=64
Respuesta desde 10.50.1.13: bytes=32 tiempo<1m TTL=64

Estadísticas de ping para 10.50.1.13:
    Paquetes: enviados = 4, recibidos = 4, perdidos = 0
    (0% perdidos),
Tiempos aproximados de ida y vuelta en milisegundos:
    Mínimo = 0ms, Máximo = 0ms, Media = 0ms
```

### Ping desde REMnux hacia Windows

```bash  
remnux@remnux:~$ ping -c4 10.50.1.14
PING 10.50.1.14 (10.50.1.14) 56(84) bytes of data.
64 bytes from 10.50.1.14: icmp_seq=1 ttl=128 time=0.429 ms
64 bytes from 10.50.1.14: icmp_seq=2 ttl=128 time=0.390 ms
64 bytes from 10.50.1.14: icmp_seq=3 ttl=128 time=0.547 ms
64 bytes from 10.50.1.14: icmp_seq=4 ttl=128 time=0.563 ms

--- 10.50.1.14 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3062ms
rtt min/avg/max/mdev = 0.390/0.482/0.563/0.074 ms
```

---

## Herramientas

[Visual Studio](https://visualstudio.microsoft.com/vs/community/)

[Visual studio code](https://code.visualstudio.com/)

[Firefox](https://www.mozilla.org/en-US/firefox/windows/)

[Windows Terminal](https://github.com/microsoft/terminal)

[LibreOffice](https://www.libreoffice.org/download/download-libreoffice/)

[Chris Titus Tech's Windows Utility](https://github.com/ChrisTitusTech/winutil)

[7-zip](https://7-zip.org/)

[VirusTotal](https://www.virustotal.com/gui/home/upload)

[ANY.RUN](https://any.run/)

[Hybrid Analysis](https://hybrid-analysis.com/)

[IDA Free](https://hex-rays.com/ida-free/)

[Cutter](https://cutter.re/)

[Ghidra](https://github.com/NationalSecurityAgency/ghidra)

[x64dbg](https://x64dbg.com/)

[pestudio](https://www.winitor.com/download)

[Eric Zimmerman's tools](https://ericzimmerman.github.io/#!index.md)

[Sysinternals Suite](https://learn.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite)

[Wireshark](https://www.wireshark.org/)

[nmap](https://nmap.org/)

[floss](https://github.com/mandiant/flare-floss)

[capa](https://github.com/mandiant/capa)

[Detect It Easy](https://community.chocolatey.org/packages/die)

[dnSpy](https://github.com/dnSpy/dnSpy)

[Bytecode Viewer](https://github.com/konloch/bytecode-viewer)

[YARA](https://github.com/VirusTotal/yara)

[010 Editor](https://www.sweetscape.com/010editor/)

[HxD](https://mh-nexus.de/en/hxd/)

[Freeware Utilities for Windows](https://www.nirsoft.net/utils/index.html)

---

## Recursos utilizados

[How to install Microsoft Windows 10 on VirtualBox - Unattended](https://www.youtube.com/watch?v=ozEohxvBGWs)

[Malware Analysis Labs: Internal Network vs Host-Only](https://notes.huskyhacks.dev/blog/malware-analysis-labs-internal-network-vs-host-only)

[The Malware Analysis Project](https://www.youtube.com/watch?v=HTCtgp0S4Bs&list=PLLDjng0_4bmMvtDw94WcyzpegCOMCs3MP)

[Malware Analysis In 5+ Hours - Full Course - Learn Practical Malware Analysis!](https://www.youtube.com/watch?v=qA0YcYMRWyI)

[FLARE-VM](https://github.com/mandiant/flare-vm)

[How to Turn Off Windows Defender in Windows 11 Permanently](https://lazyadmin.nl/win-11/turn-off-windows-defender-windows-11-permanently/)

[PERMANENTLY TURN OFF Windows Defender on Windows 11](https://www.youtube.com/watch?v=81l__vvGnjA)

[How to Disable Windows Automatic Updates on Windows 10 Permanently (2021)](https://www.youtube.com/watch?v=qFIdyzpNHBw)

[Lenny Zeltser's blog](https://zeltser.com/malicious-software/)

[Dr Josh Stroschein's youtube channel](https://www.youtube.com/@jstrosch)

[Dr Josh Stroschein's blog](https://www.thecyberyeti.com/blog)

---

## Repositorios de malware 🚨 

### Descargar repositorios como .zip y mover utilizando característica drag and drop (virtualbox) ⚠️

[PMAT-labs](https://github.com/HuskyHacks/PMAT-labs)  

[the zoo](https://github.com/ytisf/theZoo) 

[malware source code](https://github.com/vxunderground/MalwareSourceCode) 

